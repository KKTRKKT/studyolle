<html xmlns:th="https://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{fragments/settingsLayout :: base (~{::body}, ~{}, ~{})}">

<body>
<div class="row">
    <h2 class="col-12">관심있는 스터디 주제</h2>
    <div class="border-top"></div>
</div>
<div class="row mt-3">
    <div class="col-12">
        <div class="alert alert-info mb-3" role="alert" >
            <span>참여하고 싶은 스터디 주제를 입력해주세요. 해당 주제의 스터디가 생기면 알림을 받을 수 있습니다. 태그를 입력하고 콤마(,) 또는 엔터를 입력하세요</span>
        </div>
        <div id="whitelist" th:text="${whitelist}" hidden></div>
        <input id="title" type="text" th:value="${#strings.listJoin(tags, ',')}" class="form-control tagify--outside"  aria-describedby="titleHelp">
        <small id="titleHelp" class="form-text text-muted">
            공백없이 한글과 영어로만 2자 이상 20자 이내로 입력하세요.
        </small>
        <small id="invalid-feedback" class="form-text text-danger d-none">Title Error</small>
    </div>
</div>
<scripts>
    <script type="application/javascript">
        $(function (){
            const csrfToken = "[[${_csrf.token}]]";
            const csrfHeader = "[[${_csrf.headerName}]]";
            $(document).ajaxSend(function (e, xhr, options){
                xhr.setRequestHeader(csrfHeader, csrfToken);
            })
        })
    </script>
    <script src="/static/resources/node_modules/@yaireo/tagify/dist/tagify.min.js" th:src="@{/resources/node_modules/@yaireo/tagify/dist/tagify.min.js}"></script>
    <script src="/static/resources/node_modules/@yaireo/tagify/dist/tagify.polyfills.min.js" th:src="@{/resources/node_modules/@yaireo/tagify/dist/tagify.polyfills.min.js}"></script>
    <link rel="stylesheet" href="/static/resources/node_modules/@yaireo/tagify/dist/tagify.css" th:href="@{/resources/node_modules/@yaireo/tagify/dist/tagify.css}">
    <style>
        .tagify--outside .tagify__input{
            order: -1;
            flex: 100%;
            margin-bottom: 1em;
            transition: .1s;
        }
    </style>
    <script type="application/javascript">
        $(function (){
            const input = document.getElementById('title');

            const tagify = new Tagify(input, {
                pattern: /^.{2,20}[가-힣A-Za-z]*$/,
                whitelist: JSON.parse(document.querySelector("#whitelist").textContent),
                dropdown: {
                    enabled : 1 // always opens dropdown when input gets focus
                }
            })
            tagify.on("add", onAdd);
            tagify.on("remove", onRemove);
        })

        function onAdd(e) {
            tagRequest("/add", e.detail.data.value);
        }

        function onRemove(e) {
            tagRequest("/remove", e.detail.data.value);
        }

        function tagRequest(url, title) {
            $.ajax({
                url: "/settings/topic" + url,
                dataType: "json",
                data: JSON.stringify({"title" : title}),
                autocomplete: {
                    enabled: true,
                    rightKey: true
                },
                contentType: "application/json",
                method: "post",
            })
            .done(function(data, status){
                console.log("${data} and status is ${status}");
            });
        }
    </script>
</scripts>
</body>
</html>